<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEHC Tet Gifts 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fcfcfc; color: #1a1a1a; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        .tab-active { color: #e11d48; border-bottom: 3px solid #e11d48; font-weight: 800; }
        .btn-3d { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-bottom: 4px solid rgba(0,0,0,0.1); }
        .btn-3d:active { transform: translateY(2px); border-bottom-width: 1px; }
        .pack-badge { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: #475569; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="pb-24">

    <nav class="sticky top-0 z-50 glass-card px-4 py-3 flex justify-between items-center border-b">
        <div class="flex flex-col">
            <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">SEHC</span>
            <span class="text-base font-black italic">TET GIFTS 2026</span>
        </div>
        <div id="sync-status" class="w-8 h-8 flex items-center justify-center rounded-full bg-green-50 text-green-600">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-3 space-y-4">
        <div class="flex bg-white rounded-2xl p-1 shadow-sm ring-1 ring-gray-100 overflow-x-auto no-scrollbar">
            <button onclick="switchTab('receive')" id="t-receive" class="flex-none px-4 py-3 text-xs font-bold transition-all rounded-xl tab-active">Nhận quà</button>
            <button onclick="switchTab('total')" id="t-total" class="flex-none px-4 py-3 text-xs font-bold text-gray-400 transition-all rounded-xl">Tổng quà</button>
            <button onclick="switchTab('truck')" id="t-truck" class="flex-none px-4 py-3 text-xs font-bold text-gray-400 transition-all rounded-xl">Truck</button>
            <button onclick="switchTab('stats')" id="t-stats" class="flex-none px-4 py-3 text-xs font-bold text-gray-400 transition-all rounded-xl">Thống kê</button>
        </div>

        <div id="main-content"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx67zq7nRinZ5XDf2lQmDZWzod0Zi5UX3v3wN241IoDOHtIjFHOSZcoU_SxD2TdwMld/exec";
        const STATIONS = ['1. Trạm DA1', '2. Trạm DA2 - DA3', '3. Trạm EPS - VD4', '4. Trạm VD1 – VD2', '5. Trạm VD2 – VD3', '6. Trạm Admin'];
        const ITEMS = ['Bếp từ-Nồi lầu', 'Bộ nồi chảo', 'Máy massage', 'Nồi chiên', 'Nồi cơm điện', 'Set bánh kẹo'];
        
        // Quy cách đóng gói: Items per Box
        const PACKAGING = [6, 2, 12, 1, 4, 1];

        let state = {
            currentTab: 'receive',
            selectedStation: '',
            searchTerm: '',
            departments: [],
            truck: [],
            expandedDepts: new Set(),
            drillDownStation: null
        };

        window.onload = async () => {
            loadCache();
            await fetchData();
            lucide.createIcons();
        };

        function loadCache() {
            const cache = localStorage.getItem('sehc_data');
            if (cache) {
                const d = JSON.parse(cache);
                state.departments = d.departments;
                state.truck = d.truck;
                render();
            }
        }

        async function fetchData() {
            document.getElementById('sync-status').classList.add('animate-spin');
            try {
                const res = await fetch(API_URL);
                const d = await res.json();
                state.departments = d.departments;
                state.truck = d.truck;
                localStorage.setItem('sehc_data', JSON.stringify(d));
                render();
            } catch (e) { console.error(e); }
            document.getElementById('sync-status').classList.remove('animate-spin');
        }

        function switchTab(t) {
            state.currentTab = t;
            ['receive', 'total', 'truck', 'stats'].forEach(id => {
                const btn = document.getElementById('t-'+id);
                if(btn) btn.className = `flex-none px-4 py-3 text-xs font-bold transition-all rounded-xl ${id === t ? 'tab-active' : 'text-gray-400'}`;
            });
            render();
        }

        function render() {
            const container = document.getElementById('main-content');
            if (state.currentTab === 'receive') renderReceive(container);
            else if (state.currentTab === 'total') renderTotal(container);
            else if (state.currentTab === 'truck') renderTruck(container);
            else renderStats(container);
            lucide.createIcons();
        }

        // Helper tính quy cách
        function getPack(idx, total) {
            const size = PACKAGING[idx];
            const boxes = Math.floor(total / size);
            const rem = total % size;
            return { boxes, rem };
        }

        // --- TAB 1: NHẬN QUÀ ---
        function renderReceive(container) {
            container.innerHTML = `
                <div class="space-y-4">
                    <select onchange="state.selectedStation = this.value; render();" class="w-full p-4 rounded-2xl glass-card font-bold border-none ring-1 ring-gray-100 shadow-sm focus:ring-red-500 bg-white">
                        <option value="">-- Chọn Trạm --</option>
                        ${STATIONS.map(s => `<option value="${s}" ${state.selectedStation === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                    ${state.selectedStation ? `
                        <div class="relative">
                            <input type="text" placeholder="Tìm bộ phận..." oninput="state.searchTerm = this.value; renderReceiveList();" value="${state.searchTerm}"
                                class="w-full p-4 pl-12 rounded-2xl border-none ring-1 ring-gray-100 shadow-sm bg-white">
                            <i data-lucide="search" class="absolute left-4 top-4 w-5 h-5 text-gray-400"></i>
                        </div>
                        <div id="receive-list" class="space-y-3"></div>
                    ` : '<div class="text-center py-20 text-gray-400 font-medium">Vui lòng chọn trạm phát để bắt đầu</div>'}
                </div>
            `;
            if (state.selectedStation) renderReceiveList();
        }

        function renderReceiveList() {
            const list = document.getElementById('receive-list');
            let filtered = state.departments.filter(d => 
                String(d.Station).trim() === state.selectedStation.trim() && 
                d.Dept.toLowerCase().includes(state.searchTerm.toLowerCase())
            );

            filtered.sort((a, b) => {
                const aDone = isDoneAll(a);
                const bDone = isDoneAll(b);
                return aDone === bDone ? 0 : aDone ? 1 : -1;
            });

            list.innerHTML = filtered.map(dept => {
                const isAll = isDoneAll(dept);
                return `
                    <details class="group rounded-3xl overflow-hidden transition-all ${isAll ? 'bg-green-50 ring-1 ring-green-200' : 'bg-white ring-1 ring-gray-100 shadow-sm'}" 
                             ${state.expandedDepts.has(dept.Dept) ? 'open' : ''}
                             ontoggle="toggleDept('${dept.Dept}', this.open)">
                        <summary class="p-4 flex justify-between items-center cursor-pointer">
                            <div class="pr-2">
                                <h4 class="font-extrabold text-sm ${isAll ? 'text-green-700' : 'text-gray-800'} line-clamp-1">${dept.Dept}</h4>
                                <span class="text-[9px] uppercase font-bold text-gray-400">${getDoneCount(dept)}/6 Items Đã xong</span>
                            </div>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-300 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-4 pb-4 space-y-3 pt-2 border-t border-gray-50">
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl">
                                <div>
                                    <p class="text-[9px] text-gray-400 font-bold uppercase">Người nhận</p>
                                    <p class="text-xs font-bold">${dept.Contact || '---'}</p>
                                </div>
                                <a href="tel:${dept.Phone}" class="w-9 h-9 flex items-center justify-center bg-blue-500 text-white rounded-full shadow-lg shadow-blue-100 btn-3d">
                                    <i data-lucide="phone" class="w-4 h-4"></i>
                                </a>
                            </div>
                            <div class="grid gap-2">
                                ${ITEMS.map((name, i) => renderItemRow(dept, name, i)).join('')}
                            </div>
                        </div>
                    </details>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderItemRow(dept, name, i) {
            const plan = Number(dept[`Item${i+1}_P`]) || 0;
            const actual = Number(dept[`Item${i+1}_A`]) || 0;
            const isFinished = actual >= plan && plan > 0;
            if (plan === 0) return ''; 

            const pk = getPack(i, plan);

            return `
                <div class="p-3 rounded-2xl transition-all ${isFinished ? 'bg-green-100/50' : 'bg-white ring-1 ring-gray-50'}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold ${isFinished ? 'text-green-700' : 'text-gray-600'}">${name}</span>
                        <span class="text-xs font-black">${actual}/${plan}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex gap-1">
                            <span class="text-[9px] font-bold px-2 py-0.5 rounded-full pack-badge">${pk.boxes} Thùng</span>
                            <span class="text-[9px] font-bold px-2 py-0.5 rounded-full pack-badge">${pk.rem} Lẻ</span>
                        </div>
                        ${isFinished ? 
                            `<i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>` : 
                            `<button onclick="confirmGift('${dept.Dept}', ${i}, ${plan})" class="bg-red-600 text-white text-[9px] font-black px-3 py-1.5 rounded-lg shadow-md btn-3d">GIAO ĐỦ</button>`
                        }
                    </div>
                </div>
            `;
        }

        // --- TAB 2: TỔNG QUÀ (NEW) ---
        function renderTotal(container) {
            container.innerHTML = `
                <div class="space-y-4">
                    <select onchange="state.selectedStation = this.value; render();" class="w-full p-4 rounded-2xl glass-card font-bold border-none ring-1 ring-gray-100 shadow-sm bg-white">
                        <option value="">-- Chọn Trạm --</option>
                        ${STATIONS.map(s => `<option value="${s}" ${state.selectedStation === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                    
                    ${state.selectedStation ? `
                        <div class="bg-white rounded-[2rem] p-5 shadow-sm ring-1 ring-gray-100 space-y-4">
                            <h3 class="font-extrabold text-gray-800 flex items-center gap-2">
                                <i data-lucide="package-check" class="w-5 h-5 text-red-500"></i> Tổng hàng trạm phát
                            </h3>
                            <div class="grid gap-3">
                                ${ITEMS.map((name, i) => {
                                    const stDepts = state.departments.filter(d => String(d.Station).trim() === state.selectedStation.trim());
                                    const totalP = stDepts.reduce((acc, d) => acc + (Number(d[`Item${i+1}_P`]) || 0), 0);
                                    const totalA = stDepts.reduce((acc, d) => acc + (Number(d[`Item${i+1}_A`]) || 0), 0);
                                    const pk = getPack(i, totalP);
                                    
                                    return `
                                        <div class="p-4 rounded-2xl bg-slate-50 ring-1 ring-gray-100">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-sm font-black text-gray-700">${name}</span>
                                                <span class="text-sm font-black text-red-600">${totalA}/${totalP}</span>
                                            </div>
                                            <div class="flex gap-4">
                                                <div class="flex-1 bg-white p-2 rounded-xl text-center shadow-inner">
                                                    <p class="text-[9px] font-bold text-gray-400 uppercase">Số thùng</p>
                                                    <p class="text-lg font-black text-gray-800">${pk.boxes}</p>
                                                </div>
                                                <div class="flex-1 bg-white p-2 rounded-xl text-center shadow-inner">
                                                    <p class="text-[9px] font-bold text-gray-400 uppercase">Hàng lẻ</p>
                                                    <p class="text-lg font-black text-gray-800">${pk.rem}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : '<div class="text-center py-20 text-gray-400 font-medium">Chọn trạm để xem tổng quy cách</div>'}
                </div>
            `;
        }

        // --- TAB 3: TRUCK STATUS ---
        function renderTruck(container) {
            container.innerHTML = `
                <div class="bg-white rounded-[2rem] shadow-sm ring-1 ring-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-gray-50 text-gray-400 font-bold uppercase tracking-tighter">
                                <tr><th class="p-3">Trạm</th>${ITEMS.map(it => `<th class="p-3 text-center">${it.split('-')[0]}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${STATIONS.map(st => `
                                    <tr class="border-t border-gray-50">
                                        <td class="p-3 font-extrabold text-gray-700 whitespace-nowrap">${st.split('. ')[1]}</td>
                                        ${ITEMS.map(it => {
                                            const status = state.truck.find(t => t.Station === st && t.Item === it);
                                            let s = status?.Status || 0;
                                            let color = 'bg-gray-100 text-gray-300';
                                            let lbl = 'WAIT';
                                            if(s == 1) { color = 'bg-yellow-400 text-white shadow-lg shadow-yellow-100'; lbl = `IN\n${status.Time}`; }
                                            if(s == 2) { color = 'bg-green-500 text-white shadow-lg shadow-green-100'; lbl = `OUT\n${status.Time}`; }
                                            return `
                                                <td class="p-1 text-center">
                                                    <button onclick="handleTruck('${st}', '${it}')" class="w-10 h-10 rounded-lg font-black flex flex-col items-center justify-center leading-none text-[8px] btn-3d mx-auto ${color}">
                                                        ${lbl.replace('\n', '<br>')}
                                                    </button>
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- TAB 4: THỐNG KÊ ---
        function renderStats(container) {
            let totalP = 0, totalA = 0;
            state.departments.forEach(d => {
                for(let i=1; i<=6; i++) { 
                    totalP += Number(d[`Item${i}_P`]) || 0; 
                    totalA += Number(d[`Item${i}_A`]) || 0; 
                }
            });

            container.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-5 rounded-[2rem] shadow-sm ring-1 ring-gray-100 text-center">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Tổng Plan</p>
                        <h2 class="text-2xl font-black">${totalP}</h2>
                    </div>
                    <div class="bg-red-600 p-5 rounded-[2rem] shadow-xl text-center text-white">
                        <p class="text-[9px] font-bold text-red-100 uppercase">Đã phát</p>
                        <h2 class="text-2xl font-black">${totalA}</h2>
                    </div>
                </div>
                <div class="bg-white rounded-[2rem] p-6 shadow-sm ring-1 ring-gray-100 space-y-4">
                    <h3 class="font-extrabold text-gray-800">Tiến độ Trạm</h3>
                    ${STATIONS.map(st => {
                        const depts = state.departments.filter(d => String(d.Station).trim() === st.trim());
                        const done = depts.filter(isDoneAll).length;
                        const pct = depts.length ? Math.round((done/depts.length)*100) : 0;
                        const isExpanded = state.drillDownStation === st;
                        return `
                            <div class="space-y-2">
                                <button onclick="toggleDrillDown('${st}')" class="w-full flex justify-between items-center text-left">
                                    <span class="text-xs font-bold text-gray-600">${st}</span>
                                    <span class="text-[10px] font-black ${pct === 100 ? 'text-green-600' : 'text-red-500'}">${done}/${depts.length} BP</span>
                                </button>
                                <div class="w-full h-1 bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-red-500 transition-all duration-700" style="width: ${pct}%"></div>
                                </div>
                                ${isExpanded ? `
                                    <div class="bg-gray-50 rounded-xl p-2 mt-2 grid gap-1">
                                        ${depts.map(d => `
                                            <div class="flex justify-between text-[9px] font-bold p-2 bg-white rounded-lg">
                                                <span class="${isDoneAll(d) ? 'text-green-600' : 'text-gray-500'}">${d.Dept}</span>
                                                <span>${getDoneCount(d)}/6</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Logic Helpers
        function toggleDept(name, isOpen) {
            if(isOpen) state.expandedDepts.add(name);
            else state.expandedDepts.delete(name);
        }

        function toggleDrillDown(st) {
            state.drillDownStation = (state.drillDownStation === st) ? null : st;
            render();
        }

        function isDoneAll(d) {
            for(let i=1; i<=6; i++) {
                let p = Number(d[`Item${i}_P`]) || 0;
                let a = Number(d[`Item${i}_A`]) || 0;
                if(p > 0 && a < p) return false;
            }
            return true;
        }

        function getDoneCount(d) {
            let c = 0;
            for(let i=1; i<=6; i++) {
                let p = Number(d[`Item${i}_P`]) || 0;
                let a = Number(d[`Item${i}_A`]) || 0;
                if(p > 0 && a >= p) c++;
                if(p === 0) c++; 
            }
            return c;
        }

        async function confirmGift(deptName, idx, val) {
            const res = await Swal.fire({
                title: 'Giao đủ?', text: `Xác nhận giao đủ món này?`,
                icon: 'question', showCancelButton: true, confirmButtonColor: '#e11d48', confirmButtonText: 'Đã giao'
            });
            if (!res.isConfirmed) return;

            const dept = state.departments.find(d => d.Dept === deptName);
            dept[`Item${idx+1}_A`] = val;
            render();

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'UPDATE_GIFT', data: { dept: deptName, itemIdx: idx, value: val } })
            });
        }

        async function handleTruck(st, it) {
            const cur = state.truck.find(t => t.Station === st && t.Item === it);
            let nextS = 0;
            if(!cur || cur.Status == 0) nextS = 1;
            else if(cur.Status == 1) nextS = 2;
            else return;

            // if(nextS === 1) {
            //     const other = state.truck.find(t => t.Item === it && t.Status == 1);
            //     if(other) return Swal.fire('Lỗi', `Quà này đang ở ${other.Station}`, 'error');
            // }

            const time = new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
            if(!cur) state.truck.push({ Station: st, Item: it, Status: nextS, Time: time });
            else { cur.Status = nextS; cur.Time = time; }
            render();

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'UPDATE_TRUCK', data: { station: st, item: it, status: nextS, time: time } })
            });
        }
    </script>
</body>
</html>
